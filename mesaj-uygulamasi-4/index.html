    
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>DM & Genel Chat</title>
  <style>
    html, body {
      height: 100%;
      min-height: 100%;
    }
    body {
      min-height: 100vh;
      height: 100vh;
      margin: 0;
      padding: 0;
      background: #f8fafc;
      font-family: Arial, sans-serif;
      transition: background 0.2s;
    }
    
    #register-modal input[type="color"] {
      background: none !important;
      width: 32px !important;
      height: 32px !important;
      border-radius: 15%;
      border: 2px solid #6366f1;
      cursor: pointer;
      box-shadow: 0 2px 8px #6366f122;
      margin-bottom: 8px;
      margin-left: 6px;
      padding: 0;
    }
    #openRegisterBtn, #guestBtn {
      flex: 1 1 0;
      padding: 10px 0;
      background: #e0e7ff !important;
      color: #3730a3 !important;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      font-weight: 600;
      letter-spacing: 0.01em;
      margin: 0 2px;
      box-sizing: border-box;
      min-width: 0;
      max-width: 100%;
    }
    #openRegisterBtn:hover, #guestBtn:hover {
      background: #6366f1 !important;
      color: #fff !important;
    }
    #login-form > div {
      width: 100%;
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      gap: 8px;
    }
    body.dark #openRegisterBtn, body.dark #guestBtn {
      background: #232634 !important;
      color: #a5b4fc !important;
      border: none !important;
      box-shadow: none !important;
    }
    body.dark #openRegisterBtn:hover, body.dark #guestBtn:hover {
      background: #6366f1 !important;
      color: #fff !important;
    }
    #register-modal button[type="submit"] {
      width: 100%;
      padding: 10px;
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 1.1rem;
      cursor: pointer;
      margin-bottom: 0;
      margin-top: 8px;
      transition: background 0.2s, color 0.2s;
      box-shadow: none;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    #register-modal button[type="submit"]:hover {
      background: #4f46e5;
    }
    body.dark #register-modal button[type="submit"] {
      background: #6366f1;
      color: #fff;
    }
    body.dark #register-modal button[type="submit"]:hover {
      background: #4f46e5;
    }
    #register-modal input[type="text"], #register-modal input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 5px;
      border: 1.5px solid #bfc6e6;
      font-size: 1.1rem;
      box-sizing: border-box;
      background: #fff;
      color: #232634;
      transition: background 0.2s, color 0.2s, border 0.2s;
      box-shadow: none;
    }
    #register-modal input[type="text"]::placeholder,
    #register-modal input[type="password"]::placeholder {
      color: #bfc6e6;
      opacity: 1;
    }
    #register-modal input[type="text"]:focus, #register-modal input[type="password"]:focus {
      outline: none;
      border: 2px solid #6366f1;
      box-shadow: 0 0 0 2px #e0e7ff;
    }
    body.dark #register-modal input[type="text"],
    body.dark #register-modal input[type="password"] {
      background: #181a20;
      color: #e5e7eb;
      border: 1.5px solid #32344a;
      box-shadow: none;
    }
    body.dark #register-modal input[type="text"]:focus,
    body.dark #register-modal input[type="password"]:focus {
      border: 2px solid #6366f1;
      box-shadow: 0 0 0 2px #32344a;
    }
    body.dark #register-modal input[type="text"]::placeholder,
    body.dark #register-modal input[type="password"]::placeholder {
      color: #a5b4fc;
      opacity: 0.7;
    }
    /* Giriş formu inputları koyu tema için */
    #login-form input[type="text"], #login-form input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 5px;
      border: 1.5px solid #bfc6e6;
      font-size: 1.1rem;
      box-sizing: border-box;
      background: #fff;
      color: #232634;
      transition: background 0.2s, color 0.2s, border 0.2s;
      box-shadow: none;
    }
    #login-form input[type="text"]::placeholder,
    #login-form input[type="password"]::placeholder {
      color: #bfc6e6;
      opacity: 1;
    }
    #login-form input[type="text"]:focus, #login-form input[type="password"]:focus {
      outline: none;
      border: 2px solid #6366f1;
      box-shadow: 0 0 0 2px #e0e7ff;
    }
    body.dark #login-form input[type="text"],
    body.dark #login-form input[type="password"] {
      background: #181a20;
      color: #e5e7eb;
      border: 1.5px solid #32344a;
      box-shadow: none;
    }
    body.dark #login-form input[type="text"]:focus,
    body.dark #login-form input[type="password"]:focus {
      border: 2px solid #6366f1;
      box-shadow: 0 0 0 2px #32344a;
    }
    body.dark #login-form input[type="text"]::placeholder,
    body.dark #login-form input[type="password"]::placeholder {
      color: #a5b4fc;
      opacity: 0.7;
    }
        #login-form input[type="text"]:focus {
      outline: none;
      border: 2px solid #6366f1;
    }
    body.dark #login-form input[type="text"]:focus {
      border: 2px solid #6366f1;
    }
    #container {
      display: flex;
      height: 100vh;
      min-height: 100vh;
      max-width: 100vw;
      margin: 0;
      background: none;
      gap: 5px;
    }
    #sidebar {
      width: 270px;
      min-width: 220px;
      max-width: 320px;
      height: 100vh;
      min-height: 100vh;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      border-radius: 0 14px 14px 0;
      box-shadow: 0 2px 12px #0001;
      border: 1px solid #e5e7eb;
      margin: 0;
      padding: 0;
      transition: background 0.2s, color 0.2s;
    }
    #sidebar-inner {
      margin: 24px 16px 16px 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      height: 100%;
    }
    #userPanel { margin-bottom: 18px; }
    #userPanel label { font-size: 0.98rem; color: #6366f1; }
    #userPanel input[type="color"] {
      width: 26px !important;
      height: 26px !important;
      border-radius: 15%;
      border: 2px solid #6366f1;
      background: none;
      cursor: pointer;
      box-shadow: 0 2px 8px #6366f122;
      margin-bottom: 16px;
    }
    #changeUserBtn {
      background: #e0e7ff;
      color: #3730a3;
      border: none;
      border-radius: 5px;
      padding: 4px 10px;
      font-size: 0.95rem;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.2s, color 0.2s;
    }
    body.dark #changeUserBtn {
      background: #3730a3;
      color: #a5b4fc;
    }
    body.dark #changeUserBtn:hover {
      background: #6366f1;
      color: #fff;
    }
    #chatlist-form {
      background: #f6f8fa;
      border-radius: 10px;
      box-shadow: none;
      padding: 12px 6px 6px 6px;
      margin-bottom: 10px;
      border: none;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }
    #sidebar h3 {
      margin: 0 0 10px 0;
      font-size: 1.08rem;
      color: #6366f1;
      font-weight: 600;
      letter-spacing: 0.01em;
      text-align: center;
    }
    .user {
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 5px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      font-size: 1rem;
      transition: background 0.15s;
      border: none;
      background: none;
    }
    .user.active, .user:hover { background: #e0e7ff; }
    .user .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; display: inline-block; }
    #main {
      flex: 1;
      padding: 24px;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 14px 0 0 14px;
      box-shadow: 0 2px 12px #0001;
      border: 1px solid #e5e7eb;
      min-height: 100vh;
      height: 100vh;
      max-width: 100vw;
      overflow: hidden;
      transition: background 0.2s, color 0.2s;
    }
    #messages {
      list-style: none;
      padding: 0;
      max-height: calc(100vh - 180px);
      overflow-y: auto;
      flex: 1;
    }
    #messages li { margin-bottom: 12px; }
    #roomTitle { margin-bottom: 8px; }
    #m { width: 80%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; }
    #send { padding: 10px 18px; background: #6366f1; color: #fff; border: none; border-radius: 5px; font-size: 1rem; }
    #send:hover { background: #4f46e5; }
    #login-form {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 12px #0001;
      border: 1px solid #e5e7eb;
      max-width: 340px;
      margin: 80px auto 0 auto;
      padding: 32px 28px 24px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.2s, color 0.2s;
    }
    #login-form h2 {
      margin-bottom: 18px;
      font-size: 1.3rem;
      color: #6366f1;
      font-weight: 600;
    }
    #login-form input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 14px;
      border-radius: 5px;
      border: 1.5px solid #bfc6e6;
      font-size: 1.1rem;
      box-sizing: border-box;
      background: #fff;
      color: #232634;
      transition: background 0.2s, color 0.2s, border 0.2s;
      box-shadow: none;
    }
    #login-form input[type="text"]:focus {
      outline: none;
      border: 2px solid #6366f1;
      box-shadow: 0 0 0 2px #e0e7ff;
    }
    body.dark #login-form input[type="text"] {
      background: #181a20;
      color: #e5e7eb;
      border: 1.5px solid #32344a;
      box-shadow: none;
    }
    body.dark #login-form input[type="text"]:focus {
      border: 2px solid #6366f1;
      box-shadow: 0 0 0 2px #32344a;
    }
    #login-form input[type="color"] {
      width: 26px !important;
      height: 26px !important;
      border-radius: 15%;
      border: 2px solid #6366f1;
      background: none;
      cursor: pointer;
      box-shadow: 0 2px 8px #6366f122;
      margin-bottom: 16px;
    }
    #login-form button {
      width: 100%;
      padding: 10px;
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 1.1rem;
      cursor: pointer;
      margin-bottom: 0;
    }
    #login-form button:hover { background: #4f46e5; }
    /* Kayıt ol ve misafir butonları alt kısımda yan yana */
    #login-form > div {
      width: 100%;
      display: flex;
      justify-content: space-between;
      margin-top: 18px;
      gap: 8px;
    }
    #openRegisterBtn, #guestBtn {
      padding: 8px 14px;
      background: #e0e7ff;
      color: #3730a3;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #openRegisterBtn:hover, #guestBtn:hover {
      background: #6366f1;
      color: #fff;
    }
    /* Kayıt modalı */
    #register-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(24,26,32,0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
      transition: background 0.2s;
    }
    #register-modal[style*="display: flex"] {
      display: flex !important;
    }
    #register-modal form {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 16px #0003;
      border: 1px solid #e5e7eb;
      max-width: 340px;
      width: 90vw;
      margin: auto;
      padding: 32px 28px 24px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      animation: popIn 0.2s;
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
    body.dark #register-modal {
      background: rgba(24,26,32,0.97);
    }
    body.dark #register-modal form {
      background: #232634;
      color: #e5e7eb;
      border-color: #32344a;
      box-shadow: 0 2px 24px #0008;
    }
    body.dark #register-modal h2 {
      color: #a5b4fc;
    }
    body.dark #register-modal label span {
      color: #a5b4fc;
    }
    body.dark #register-modal button[type="submit"] {
      background: #6366f1;
      color: #fff;
    }
    body.dark #register-modal button[type="submit"]:hover {
      background: #4f46e5;
    }
    #closeRegisterModal {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 1.3rem;
      color: #6366f1;
      cursor: pointer;
      transition: color 0.2s;
      z-index: 10;
    }
    #closeRegisterModal:hover {
      color: #4f46e5;
    }
    body.dark #closeRegisterModal {
      color: #a5b4fc;
    }
    body.dark #closeRegisterModal:hover {
      color: #fff;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes popIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    /* Koyu tema için modal ve butonlar */
    body.dark #openRegisterBtn, body.dark #guestBtn {
      background: #3730a3;
      color: #a5b4fc;
    }
    body.dark #openRegisterBtn:hover, body.dark #guestBtn:hover {
      background: #6366f1;
      color: #fff;
    }
    .sender { font-weight: bold; display: block; margin-bottom: 2px; }
    /* Tema butonu */
    #theme-toggle {
      position: fixed;
      top: 18px;
      right: 24px;
      z-index: 1000;
      background: #fff;
      color: #6366f1;
      border: 1.5px solid #e5e7eb;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    #theme-toggle:hover {
      background: #6366f1;
      color: #fff;
    }
    /* Koyu tema */
    body.dark {
      background: #181a20;
      color: #e5e7eb;
    }
    body.dark #sidebar,
    body.dark #main,
    body.dark #login-form {
      background: #232634;
      color: #e5e7eb;
      border-color: #32344a;
      box-shadow: 0 2px 16px #0006;
    }
    body.dark #sidebar h3,
    body.dark #login-form h2 {
      color: #a5b4fc;
    }
    body.dark .user.active, body.dark .user:hover {
      background: #32344a;
    }
    body.dark #chatlist-form {
      background: #232634;
      border-color: #32344a;
    }
    body.dark #send, body.dark #login-form button {
      background: #6366f1;
      color: #fff;
      border: none;
    }
    body.dark #send:hover, body.dark #login-form button:hover {
      background: #4f46e5;
    }
    body.dark #m {
      background: #181a20;
      color: #e5e7eb;
      border-color: #32344a;
    }
    body.dark #m::placeholder {
      color: #a5b4fc;
      opacity: 0.7;
    }
    body.dark #theme-toggle {
      background: #232634;
      color: #a5b4fc;
      border-color: #32344a;
    }
    body.dark #theme-toggle:hover {
      background: #6366f1;
      color: #fff;
    }
    /* Dil butonu koyu tema */
    body.dark #lang-toggle {
      background: #232634 !important;
      color: #a5b4fc !important;
      border-color: #32344a !important;
    }
    body.dark #lang-toggle:hover {
      background: #6366f1 !important;
      color: #fff !important;
    }
    @media (max-width: 900px) {
      #sidebar { width: 180px; min-width: 120px; }
    }
    @media (max-width: 700px) {
      #container { flex-direction: column; min-width: 0; gap: 0; height: 100vh; }
      #sidebar, #main { min-height: unset; border-radius: 0; height: auto; }
      #sidebar { width: 100vw; max-width: 100vw; border-right: none; border-bottom: 1px solid #e5e7eb; }
      #main { padding: 12px; }
      #sidebar-inner { margin: 12px 4px; }
      #chatlist-form { padding: 8px 4px; }
      #login-form { margin: 40px 8px 0 8px; }
      #theme-toggle { top: 10px; right: 10px; }
    }
  </style>
</head>
<body>
  <button id="theme-toggle" title="Tema Değiştir">🌙</button>
  <button id="lang-toggle" style="position:fixed;top:70px;right:24px;z-index:1000;background:#fff;color:#6366f1;border:1.5px solid #e5e7eb;border-radius:12px;width:44px;height:32px;font-size:1.05rem;cursor:pointer;box-shadow:0 2px 8px #0002;display:flex;align-items:center;justify-content:center;transition:background 0.2s,color 0.2s;">EN</button>
  <div id="login">
    <form id="login-form" autocomplete="off" style="display: flex; flex-direction: column; align-items: center; margin-bottom: 18px; position: relative;">
      <h2>Giriş Yap</h2>
      <input id="login-username" type="text" autocomplete="off" placeholder="Kullanıcı adınız" required />
      <input id="login-password" type="password" autocomplete="off" placeholder="Şifre" required style="margin-bottom:14px;" />
      <button id="loginBtn" type="submit">Giriş Yap</button>
      <div style="width:100%; display:flex; justify-content:space-between; margin-top:18px;">
        <button id="openRegisterBtn" type="button" style="padding: 8px 14px; background: #e0e7ff; color: #3730a3; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer;">Hesap Aç</button>
        <button id="guestBtn" type="button" style="padding: 8px 14px; background: #e0e7ff; color: #3730a3; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer;">Misafir Olarak Devam Et</button>
      </div>
    </form>

    <!-- Kayıt olma modalı -->
    <div id="register-modal">
      <form id="register-form" autocomplete="off">
        <button type="button" id="closeRegisterModal">&times;</button>
        <h2>Hesap Aç</h2>
        <input id="reg-username" type="text" autocomplete="off" placeholder="Kullanıcı adınız" required />
        <input id="reg-password" type="password" autocomplete="off" placeholder="Şifre" required />
        <label style="display:block; margin-bottom:10px; margin-top:4px;">
          <span style="margin-right:6px;">İsim Rengi:</span>
          <input type="color" id="reg-userColor" value="#6366f1" />
        </label>
        <button id="registerBtn" type="submit">Hesap Aç</button>
      </form>
    </div>
  </div>
  <div id="container" style="display:none;">
    <div id="sidebar">
      <div id="sidebar-inner">
        <div id="userPanel">
          <span id="currentUser" style="font-weight:bold;"></span><br>
          <label>
            <span>İsim Rengi:</span>
            <input type="color" id="userColorPanel" value="#6366f1" />
          </label><br>
          <button id="changeUserBtn">Kullanıcı Adı Değiştir</button>
        </div>
        <form id="chatlist-form" onsubmit="return false;">
          <h3>Sohbetler</h3>
          <div id="chatlist"></div>
        </form>
      </div>
    </div>
    <div id="main">
      <div id="roomTitle">Genel Sohbet</div>
      <ul id="messages"></ul>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="m" autocomplete="off" placeholder="Mesajınız" />
        <button id="send">Gönder</button>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Çoklu dil desteği
    const LANGS = {
      tr: {
        title: 'DM & Genel Chat',
        loginTitle: 'Hesap Aç',
        usernamePlaceholder: 'Kullanıcı adınız',
        passwordPlaceholder: 'Şifre',
        colorLabel: 'İsim Rengi:',
        loginBtn: 'Tamam',
        registerBtn: 'Hesap Aç',
        guestBtn: 'Misafir Olarak Devam Et',
        changeUser: 'Kullanıcı Adı Değiştir',
        chats: 'Sohbetler',
        general: '🌐 Genel Sohbet',
        dmWith: name => `💬 ${name} ile DM`,
        send: 'Gönder',
        msgPlaceholder: 'Mesajınız',
        theme: 'Tema Değiştir',
        themeLight: 'Açık Tema',
        themeDark: 'Koyu Tema',
        lang: 'EN',
        langSwitch: 'Dili Değiştir'
      },
      en: {
        title: 'DM & General Chat',
        loginTitle: 'Sign Up',
        usernamePlaceholder: 'Your username',
        passwordPlaceholder: 'Password',
        colorLabel: 'Name Color:',
        loginBtn: 'OK',
        registerBtn: 'Sign Up',
        guestBtn: 'Continue as Guest',
        changeUser: 'Change Username',
        chats: 'Chats',
        general: '🌐 General Chat',
        dmWith: name => `💬 DM with ${name}`,
        send: 'Send',
        msgPlaceholder: 'Your message',
        theme: 'Switch Theme',
        themeLight: 'Light Theme',
        themeDark: 'Dark Theme',
        lang: 'TR',
        langSwitch: 'Switch Language'
      }
    };
    let currentLang = localStorage.getItem('lang') || 'tr';
    function setLang(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      document.title = LANGS[lang].title;
      // Giriş ekranı ve kayıt ekranı
      // Giriş başlığı
      if (document.querySelector('#login-form h2'))
        document.querySelector('#login-form h2').textContent = lang === 'tr' ? 'Giriş Yap' : 'Sign In';
      // Giriş input placeholder
      if (document.getElementById('login-username'))
        document.getElementById('login-username').placeholder = LANGS[lang].usernamePlaceholder;
      if (document.getElementById('login-password'))
        document.getElementById('login-password').placeholder = LANGS[lang].passwordPlaceholder;
      // Giriş butonu
      if (document.getElementById('loginBtn'))
        document.getElementById('loginBtn').textContent = lang === 'tr' ? 'Giriş Yap' : 'Sign In';
      // Kayıt başlığı
      if (document.querySelector('#register-form h2'))
        document.querySelector('#register-form h2').textContent = LANGS[lang].loginTitle;
      // Kayıt input placeholder
      if (document.getElementById('reg-username'))
        document.getElementById('reg-username').placeholder = LANGS[lang].usernamePlaceholder;
      if (document.getElementById('reg-password'))
        document.getElementById('reg-password').placeholder = LANGS[lang].passwordPlaceholder;
      // Kayıt renk label
      if (document.querySelector('#register-form label span'))
        document.querySelector('#register-form label span').textContent = LANGS[lang].colorLabel;
      // Kayıt butonu
      if (document.getElementById('registerBtn'))
        document.getElementById('registerBtn').textContent = LANGS[lang].registerBtn;
      // Hesap Aç butonu
      if (document.getElementById('openRegisterBtn'))
        document.getElementById('openRegisterBtn').textContent = LANGS[lang].registerBtn;
      // Misafir butonu
      if (document.getElementById('guestBtn'))
        document.getElementById('guestBtn').textContent = LANGS[lang].guestBtn;
      // Diğer alanlar
      if (document.getElementById('changeUserBtn'))
        document.getElementById('changeUserBtn').textContent = LANGS[lang].changeUser;
      if (document.querySelector('#chatlist-form h3'))
        document.querySelector('#chatlist-form h3').textContent = LANGS[lang].chats;
      if (document.getElementById('send'))
        document.getElementById('send').textContent = LANGS[lang].send;
      if (document.getElementById('m'))
        document.getElementById('m').placeholder = LANGS[lang].msgPlaceholder;
      if (document.getElementById('theme-toggle'))
        document.getElementById('theme-toggle').title = LANGS[lang].theme;
      if (document.getElementById('lang-toggle')) {
        document.getElementById('lang-toggle').textContent = LANGS[lang].lang;
        document.getElementById('lang-toggle').title = LANGS[lang].langSwitch;
      }
      // Oda başlığı
      if (privateTo === null) {
        document.getElementById('roomTitle').textContent = LANGS[lang].general;
      } else {
        document.getElementById('roomTitle').textContent = LANGS[lang].dmWith(privateName);
      }
      renderChatList();
    }
    document.addEventListener('DOMContentLoaded', function() {
      setLang(currentLang);
    });
    document.getElementById('lang-toggle').onclick = function() {
      setLang(currentLang === 'tr' ? 'en' : 'tr');
    };
    // Tema değiştirici
    const themeBtn = document.getElementById('theme-toggle');
    function setTheme(dark) {
      document.body.classList.toggle('dark', dark);
      themeBtn.innerHTML = dark ? '☀️' : '🌙';
      themeBtn.title = dark ? 'Açık Tema' : 'Koyu Tema';
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    }
    // İlk yüklemede tema
    setTheme(localStorage.getItem('theme') === 'dark');
    themeBtn.onclick = () => setTheme(!document.body.classList.contains('dark'));

    // Chat uygulaması kodları (giriş sistemi güncellendi)
    const socket = io();
    let username = '';
    let userColor = '#6366f1';
    let users = [];
    let privateTo = null; // socket.id
    let privateName = '';
    let privateColor = '';
    let mySocketId = null;
    let isGuest = false;

    // Mesaj geçmişi: { genel: [...], <socketId>: [...] }
    let messageHistory = { genel: [] };

    // DOM
    const loginDiv = document.getElementById('login');
  const loginForm = document.getElementById('login-form');
  const loginUsernameInput = document.getElementById('login-username');
  const loginPasswordInput = document.getElementById('login-password');
  const loginBtn = document.getElementById('loginBtn');
  const registerForm = document.getElementById('register-form');
  const regUsernameInput = document.getElementById('reg-username');
  const regPasswordInput = document.getElementById('reg-password');
  const regUserColorInput = document.getElementById('reg-userColor');
  const registerBtn = document.getElementById('registerBtn');
  const guestBtn = document.getElementById('guestBtn');
    const userColorPanel = document.getElementById('userColorPanel');
    const container = document.getElementById('container');
    const chatlistDiv = document.getElementById('chatlist');
    const messages = document.getElementById('messages');
    const msgInput = document.getElementById('m');
    const sendBtn = document.getElementById('send');
    const roomTitle = document.getElementById('roomTitle');
    const userPanel = document.getElementById('userPanel');
    const currentUser = document.getElementById('currentUser');
    const changeUserBtn = document.getElementById('changeUserBtn');

    function showUserPanel(name, color) {
      currentUser.textContent = name ? `👤 ${name}` : '';
      currentUser.style.color = color || '#6366f1';
      userPanel.style.display = name ? 'block' : 'none';
      if (userColorPanel) userColorPanel.value = color || '#6366f1';
    }


    // Giriş yapma formu gönderildiğinde
    loginForm.onsubmit = function(e) {
      e.preventDefault();
      if (!loginUsernameInput.value.trim() || !loginPasswordInput.value.trim()) return;
      username = loginUsernameInput.value.trim();
      userColor = '#6366f1';
      isGuest = false;
      loginDiv.style.display = 'none';
      container.style.display = 'flex';
      showUserPanel(username, userColor);
      // Şifreyi sunucuya göndermiyoruz, demo amaçlı sadece isim gönderiyoruz
      socket.emit('register', { name: username, color: userColor });
      msgInput.focus();
    };

    // Kayıt olma modalı açma/kapama
    const openRegisterBtn = document.getElementById('openRegisterBtn');
    const registerModal = document.getElementById('register-modal');
    const closeRegisterModal = document.getElementById('closeRegisterModal');
    if (openRegisterBtn && registerModal) {
      openRegisterBtn.onclick = function() {
        registerModal.style.display = 'flex';
        document.getElementById('reg-username').focus();
      };
    }
    if (closeRegisterModal && registerModal) {
      closeRegisterModal.onclick = function() {
        registerModal.style.display = 'none';
      };
    }
    // Modal dışında tıklayınca kapansın
    if (registerModal) {
      registerModal.addEventListener('click', function(e) {
        if (e.target === registerModal) registerModal.style.display = 'none';
      });
    }

    // Hesap açma formu gönderildiğinde
    registerForm.onsubmit = function(e) {
      e.preventDefault();
      if (!regUsernameInput.value.trim() || !regPasswordInput.value.trim()) return;
      username = regUsernameInput.value.trim();
      userColor = regUserColorInput.value || '#6366f1';
      isGuest = false;
      registerModal.style.display = 'none';
      loginDiv.style.display = 'none';
      container.style.display = 'flex';
      showUserPanel(username, userColor);
      // Şifreyi sunucuya göndermiyoruz, demo amaçlı sadece isim ve renk gönderiyoruz
      socket.emit('register', { name: username, color: userColor });
      msgInput.focus();
    };

    // Misafir olarak devam et butonu
    guestBtn.onclick = function() {
      username = 'Misafir-' + Math.floor(Math.random() * 10000);
      userColor = '#6366f1';
      isGuest = true;
      loginDiv.style.display = 'none';
      container.style.display = 'flex';
      showUserPanel(username, userColor);
      socket.emit('register', { name: username, color: userColor });
      msgInput.focus();
    };

    if (userColorPanel) {
      userColorPanel.addEventListener('input', function() {
        userColor = userColorPanel.value;
        currentUser.style.color = userColor;
        socket.emit('register', { name: username, color: userColor });
      });
    }

    changeUserBtn.onclick = function() {
      container.style.display = 'none';
      loginDiv.style.display = 'block';
      if (regUsernameInput) regUsernameInput.value = '';
      if (regPasswordInput) regPasswordInput.value = '';
      if (regUsernameInput) regUsernameInput.focus();
      showUserPanel('', userColor);
    };

    socket.on('connect', () => {
      mySocketId = socket.id;
    });

    socket.on('userlist', (userArr) => {
      users = userArr;
      renderChatList();
    });

    function renderChatList() {
      chatlistDiv.innerHTML = '';
      // Genel sohbet en üstte sabit
      const genel = document.createElement('div');
      genel.textContent = LANGS[currentLang].general;
      genel.className = 'user' + (privateTo === null ? ' active' : '');
      genel.onclick = () => {
        privateTo = null;
        roomTitle.textContent = LANGS[currentLang].general;
        renderChatList();
        renderMessages();
      };
      chatlistDiv.appendChild(genel);

      users.forEach(u => {
        if (u.name === username) return; // Kendini listeleme
        const div = document.createElement('div');
        div.className = 'user' + (privateTo === u.socketId ? ' active' : '');
        div.innerHTML = `<span class="dot" style="background:${u.color || '#6366f1'}"></span>${u.name}`;
        div.onclick = () => {
          privateTo = u.socketId;
          privateName = u.name;
          privateColor = u.color || '#6366f1';
          roomTitle.textContent = LANGS[currentLang].dmWith(u.name);
          renderChatList();
          renderMessages();
        };
        chatlistDiv.appendChild(div);
      });
    }

    sendBtn.onclick = function() {
      if (!msgInput.value.trim()) return;
      if (privateTo) {
        socket.emit('private message', { to: privateTo, msg: msgInput.value });
      } else {
        socket.emit('chat message', { name: username, text: msgInput.value, color: userColor });
      }
      msgInput.value = '';
    };

    msgInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    socket.on('chat message', function(msg){
      if (!messageHistory.genel) messageHistory.genel = [];
      messageHistory.genel.push(msg);
      if (privateTo === null) renderMessages();
    });

    socket.on('private message', function({ from, msg, user }) {
      const key = from === mySocketId ? privateTo : from;
      if (!messageHistory[key]) messageHistory[key] = [];
      if (from === mySocketId) {
        messageHistory[key].push({ name: user.name, text: msg, color: user.color });
      } else if (privateTo === from) {
        messageHistory[key].push({ name: user.name, text: msg, color: user.color });
      }
      if (privateTo === key) renderMessages();
    });

    function renderMessages() {
      messages.innerHTML = '';
      let key = privateTo === null ? 'genel' : privateTo;
      (messageHistory[key] || []).forEach(msg => {
        const li = document.createElement('li');
        const safeColor = /^#[0-9a-fA-F]{6}$/.test(msg.color) ? msg.color : '#6366f1';
        li.innerHTML = `<span class="sender" style="color:${safeColor}">${msg.name}</span><span>${msg.text}</span>`;
        messages.appendChild(li);
      });
      messages.scrollTop = messages.scrollHeight;
    }
  </script>
</body>
</html>